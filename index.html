<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æœå‹™æ„è¦‹èª¿æŸ¥è¡¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* èªç³»åˆ‡æ›æŒ‰éˆ•æ•ˆæœ */
        .lang-btn { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); background-color: white; color: #4b5563; border: 1px solid #e5e7eb; }
        .lang-btn.active { 
            background-color: #2563eb !important; 
            color: white !important; 
            border-color: #1e40af !important; 
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            transform: translateY(-1px);
        }

        /* è¡¨å–®å…ƒç´ ç¾åŒ– */
        input[type="radio"]:checked + span { color: #2563eb; font-weight: 700; }
        .question-card { border-radius: 1.5rem; border: 1px solid #f3f4f6; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        input:focus, textarea:focus { box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); background-color: white !important; border-color: #2563eb !important; }
        #submitBtn:disabled { background-color: #94a3b8; cursor: not-allowed; opacity: 0.5; }
        
        /* ç§»é™¤ç·¨è™Ÿä¸Šä¸‹ç®­é ­ */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* æˆåŠŸå½ˆçª— */
        #successModal { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-show { opacity: 1; pointer-events: auto; transform: scale(1); }
        .modal-hide { opacity: 0; pointer-events: none; transform: scale(0.95); }
        
        @keyframes pulse-gold { 
            0% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7); } 
            70% { box-shadow: 0 0 0 15px rgba(251, 191, 36, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); } 
        }
        .btn-active-highlight { animation: pulse-gold 2s infinite; background-color: #fbbf24; color: #1e293b; }
        .btn-dimmed { background-color: #f1f5f9; color: #94a3b8; border: 1px solid #e2e8f0; }
        .status-ready { color: #10b981 !important; font-weight: 900; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-12">

<div id="app" class="max-w-md mx-auto">
    <header class="bg-white sticky top-0 z-20 shadow-sm px-4 py-4 mb-4 text-center">
        <h1 class="text-xl font-bold text-gray-800" data-i18n="title">æœå‹™æ„è¦‹èª¿æŸ¥è¡¨</h1>
        <p id="conn-info" class="text-[8px] text-gray-400 font-mono tracking-widest uppercase italic">Establishing Secure Connection...</p>
        <div class="flex justify-between gap-1 bg-gray-100 p-1 rounded-2xl border border-gray-200 mt-4">
            <button onclick="window.changeLang('zh')" id="btn-zh" class="lang-btn active flex-1 py-2.5 rounded-xl text-xs font-bold">ä¸­æ–‡</button>
            <button onclick="window.changeLang('en')" id="btn-en" class="lang-btn flex-1 py-2.5 rounded-xl text-xs font-bold">EN</button>
            <button onclick="window.changeLang('ja')" id="btn-ja" class="lang-btn flex-1 py-2.5 rounded-xl text-xs font-bold">æ—¥æœ¬èª</button>
            <button onclick="window.changeLang('ko')" id="btn-ko" class="lang-btn flex-1 py-2.5 rounded-xl text-xs font-bold">í•œêµ­ì–´</button>
        </div>
    </header>

    <main class="px-4 space-y-4">
        <form id="surveyForm" class="space-y-4">
            <div class="bg-white p-5 rounded-3xl border border-blue-100 shadow-sm">
                <label class="block text-[10px] font-bold text-blue-400 mb-1 uppercase tracking-tighter" data-i18n="branchLabel">æœå‹™åˆ†åº—</label>
                <div class="flex items-center text-gray-800 font-bold text-lg italic">ğŸ“ <span data-i18n="branchName">ä¸­æ¸…è¡Œé¤¨</span></div>
            </div>

            <!-- å‹•æ…‹ç”Ÿæˆé¡Œç›® -->
            <div id="questionsContainer" class="space-y-4"></div>

            <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm space-y-5">
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase" data-i18n="masseurIdLabel">å¸«å‚…è™Ÿç¢¼ *</label>
                    <input type="number" id="masseurId" required data-ph="ph_masseur" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl text-xl font-bold outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase" data-i18n="dateLabel">æœå‹™æ—¥æœŸ *</label>
                    <input type="date" id="serviceDate" required class="w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl text-base outline-none cursor-pointer" onkeydown="return false">
                </div>
                <div><label class="block text-xs font-bold text-gray-400 mb-2 uppercase" data-i18n="custNameLabel">è²´è³“å§“å</label><input type="text" id="custName" data-ph="ph_name" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl outline-none"></div>
                <div><label class="block text-xs font-bold text-gray-400 mb-2 uppercase" data-i18n="phoneLabel">è¯çµ¡é›»è©±</label><input type="tel" id="custPhone" data-ph="ph_phone" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl outline-none"></div>
                <div><label class="block text-xs font-bold text-gray-400 mb-2 uppercase" data-i18n="suggestLabel">å»ºè­°å…§å®¹è©³è¿°</label><textarea id="suggestions" rows="3" data-ph="ph_suggest" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl outline-none"></textarea></div>
            </div>

            <button type="submit" id="submitBtn" disabled class="w-full bg-blue-600 text-white font-black py-5 rounded-3xl shadow-lg active:scale-95 transition-all text-lg opacity-50"><span data-i18n="submitBtn">æäº¤å•å· Submit</span></button>
        </form>
    </main>

    <!-- æˆåŠŸè¡ŒéŠ·å¼•å° Modal -->
    <div id="successModal" class="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-slate-900/80 backdrop-blur-md modal-hide">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] overflow-hidden shadow-2xl text-center border-b-8 border-amber-400">
            <div class="bg-blue-600 py-10 text-white">
                <div class="text-6xl mb-4">âœ¨</div>
                <h3 class="text-2xl font-black italic" data-i18n="modalTitle">æ„Ÿè¬æ‚¨çš„å›é¥‹ï¼</h3>
                <p class="text-xs opacity-80 mt-2 font-bold uppercase tracking-widest" data-i18n="modalSub">Feedback Successfully Received</p>
            </div>
            <div class="p-8 space-y-6">
                <p class="text-gray-600 font-bold text-sm leading-relaxed" data-i18n="modalText">æ‚¨çš„æ”¯æŒæ˜¯æˆ‘å€‘é€²æ­¥çš„å‹•åŠ›ã€‚<br>é‚€è«‹æ‚¨ç•™ä¸‹ 5 æ˜Ÿå¥½è©•ï¼</p>
                <div class="space-y-3">
                    <button onclick="handleMarketingAction('Reviewed')" class="btn-active-highlight block w-full font-black py-4 rounded-2xl shadow-lg transition-all text-lg flex items-center justify-center gap-2">
                        <span>â­</span> <span data-i18n="modalGoGoogle">é¦¬ä¸Šè©•è«–</span>
                    </button>
                    <button onclick="handleMarketingAction('Dismissed')" class="btn-dimmed block w-full font-bold py-3 rounded-2xl transition-all text-sm" data-i18n="modalClose">ä¸‹æ¬¡å†è©•</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-8 py-4 rounded-full shadow-2xl transition-all opacity-0 pointer-events-none z-50 text-sm font-bold min-w-[280px] text-center"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCuytMbR0wfPk0vChxqI66Zci0uJtGiizE",
        authDomain: "survey-c3aa5.firebaseapp.com",
        projectId: "survey-c3aa5",
        storageBucket: "survey-c3aa5.firebasestorage.app",
        messagingSenderId: "874594469122",
        appId: "1:874594469122:web:2b2c1208b20d2095b9ae1b",
        measurementId: "G-B5T1318ZR4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let isAuthorized = false;
    let lastDocId = null;

    // --- è‡ªå‹•åŒ–å°é½Šç¿»è­¯åº« (æ ¸å¿ƒå­—å…¸) ---
    const translations = {
        zh: { 
            title: "æœå‹™æ„è¦‹èª¿æŸ¥è¡¨", branchLabel: "æœå‹™åˆ†åº—", branchName: "ä¸­æ¸…è¡Œé¤¨", dateLabel: "æœå‹™æ—¥æœŸ *", 
            q1: "æœå‹™é–‹å§‹æœ‰ä»‹ç´¹è™Ÿç¢¼è©¢å•æ¶ˆè²»é …ç›®å—ï¼Ÿ", q1_a1: "ä¸»å‹•ä»‹ç´¹è©¢å•", q1_a2: "å¾Œä¾†æ‰å•", q1_a3: "å®Œå…¨æ²’å•", 
            q2: "æœå‹™éç¨‹æœ‰ä¸»å‹•è©¢å•èª¿æ•´åŠ›é“å¤§å°å—ï¼Ÿ", q2_a1: "ä¸»å‹•è©¢å•èª¿æ•´", q2_a2: "è¢«å‹•å›æ‡‰", q2_a3: "å®Œå…¨ä¸å•", 
            q3: "å¸«å‚…èº«ä¸Šæœ‰ç•°å‘³æˆ–ç…™å‘³è®“æ‚¨ä¸èˆ’æœå—ï¼Ÿ", q3_a1: "æ²’æœ‰ç•°å‘³", q3_a2: "ç¨å¾®æœ‰é»", q3_a3: "å‘³é“å¾ˆé‡", 
            q4: "æœå‹™æµç¨‹æ™‚é–“æŒæ¡å¾—ç•¶å—ï¼Ÿ", q4_a1: "æœå‹™å¾ˆå¥½", q4_a2: "æ™®é€šå°šå¯", q4_a3: "æ„Ÿè¦ºå¾ˆå·®", 
            q5: "æœå‹™éç¨‹å¸«å‚…æœ‰è¨€èªè¼•ä½»æˆ–ä¸ç¦®è²Œå—ï¼Ÿ", q5_a1: "è‰¯å¥½æœ‰ç¦®", q5_a2: "æ™®é€šå°šå¯", q5_a3: "è¨€èªä¸ç•¶", 
            q6: "åŒ…å»‚æŒ‰æ‘©æœå‹™æœ‰è‚¢é«”è§¸ç¢°è®“ä½ å°·å°¬å—ï¼Ÿ", q6_a1: "å°ˆæ¥­å¾—é«”", q6_a2: "æœ‰é»å°·å°¬", q6_a3: "æ„Ÿè¦ºå¾ˆå·®", 
            q7: "åŒ…å»‚æœ‰é–‹æ¤ç”©é ­è¸©èƒŒç­‰ç¦æ­¢å±éšªå‹•ä½œï¼Ÿ", q7_a1: "å®Œå…¨æ²’æœ‰", q7_a2: "æœ‰é»å±éšª", q7_a3: "éå¸¸å±éšª", 
            q8: "å¸«å‚…æœ‰é‚€è«‹æ‰“å¡æŒ‰è®šä»‹ç´¹å„ªæƒ æ´»å‹•å—ï¼Ÿ", q8_a1: "ç†±æƒ…ä¸»å‹•", q8_a2: "éå¸¸è¢«å‹•", q8_a3: "å®Œå…¨æ²’èªª", 
            q9: "å¸«å‚…æœå‹™çµæŸé€å®¢æœ‰ä¸»å‹•çµ¦æ‚¨åç‰‡å—ï¼Ÿ", q9_a1: "ç†±æƒ…ä¸»å‹•", q9_a2: "è¦äº†æ‰çµ¦", q9_a3: "æ²’æœ‰çµ¦åç‰‡", 
            q10: "ä»Šå¤©æœå‹™çš„å¸«å‚…æœƒè®“æ‚¨ä¸‹æ¬¡å†è€é»ä»–å—ï¼Ÿ", q10_a1: "ä¸€å®šè€é»", q10_a2: "å†è©¦è©¦çœ‹", q10_a3: "çµ•å°ä¸æœƒ", 
            masseurIdLabel: "å¸«å‚…è™Ÿç¢¼ *", submitBtn: "æäº¤å•å· Submit", ph_masseur: "è¼¸å…¥ç·¨è™Ÿ", ph_name: "è¼¸å…¥å§“å", ph_phone: "è¼¸å…¥é›»è©±", ph_suggest: "æ‚¨çš„å»ºè­°...", suc: "âœ… æäº¤æˆåŠŸï¼", err: "âŒ å¯«å…¥å¤±æ•—", authReady: "Secure Cloud Ready",
            modalTitle: "æ„Ÿè¬æ‚¨çš„å›é¥‹ï¼", modalSub: "Success Received", modalText: "æ‚¨çš„æ”¯æŒæ˜¯æˆ‘å€‘é€²æ­¥çš„å‹•åŠ›ã€‚<br>é‚€è«‹æ‚¨ç•™ä¸‹ 5 æ˜Ÿå¥½è©•ï¼", modalGoGoogle: "é¦¬ä¸Šè©•è«–", modalClose: "ä¸‹æ¬¡å†è©•"
        },
        en: { 
            title: "Service Survey", branchLabel: "Branch", branchName: "Zhongqing Branch", dateLabel: "Date *", 
            q1: "ID introduction at start?", q1_a1: "Proactive", q1_a2: "Later", q1_a3: "No", 
            q2: "Pressure adjust check?", q2_a1: "Proactive", q2_a2: "Passive", q2_a3: "No",
            q3: "Unpleasant odor?", q3_a1: "No odor", q3_a2: "A little", q3_a3: "Strong",
            q4: "Service timing?", q4_a1: "Excellent", q4_a2: "Average", q4_a3: "Poor",
            q5: "Politeness?", q5_a1: "Polite", q5_a2: "Average", q5_a3: "Impolite",
            q6: "Awkward touch?", q6_a1: "Professional", q6_a2: "Awkward", q6_a3: "Poor",
            q7: "Dangerous moves?", q7_a1: "None", q7_a2: "Risky", q7_a3: "Dangerous",
            q8: "Promotion intro?", q8_a1: "Proactive", q8_a2: "Passive", q8_a3: "None",
            q9: "Business card offered?", q9_a1: "Proactive", q9_a2: "Requested", q9_a3: "No",
            q10: "Would you re-book?", q10_a1: "Definitely", q10_a2: "Maybe", q10_a3: "Never", 
            masseurIdLabel: "Masseur ID *", submitBtn: "Submit Survey", ph_masseur: "ID No.", ph_name: "Name", ph_phone: "Phone", ph_suggest: "Feedback...", suc: "âœ… Submitted!", err: "âŒ Failed", authReady: "Secure Cloud Ready",
            modalTitle: "Thank You!", modalSub: "Success Received", modalText: "We value your feedback.<br>Please leave a 5-star review!", modalGoGoogle: "Review Now", modalClose: "Maybe Later"
        },
        ja: { 
            title: "ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ", branchLabel: "åº—èˆ—", branchName: "ä¸­æ¸…åº—", dateLabel: "æ—¥ä»˜ *", 
            q1: "ç•ªå·ç´¹ä»‹ã¯ã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿ", q1_a1: "ç©æ¥µçš„", q1_a2: "å¾Œã§", q1_a3: "ãªã—", 
            q2: "åŠ›åŠ æ¸›ã®ç¢ºèªã¯ï¼Ÿ", q2_a1: "ç©æ¥µçš„", q2_a2: "å—å‹•çš„", q2_a3: "ãªã—",
            q3: "è‡­ã„ã¯æ°—ã«ãªã‚Šã¾ã—ãŸã‹ï¼Ÿ", q3_a1: "ãªã—", q3_a2: "å°‘ã—", q3_a3: "éå¸¸ã«",
            q4: "æ™‚é–“é…åˆ†ã¯é©åˆ‡ï¼Ÿ", q4_a1: "éå¸¸ã«è‰¯ã„", q4_a2: "æ™®é€š", q4_a3: "æ‚ªã„",
            q5: "ãƒãƒŠãƒ¼ãŒä¸é©åˆ‡ï¼Ÿ", q5_a1: "ä¸å¯§", q5_a2: "æ™®é€š", q5_a3: "å¤±ç¤¼",
            q6: "ä¸å¿«ãªèº«é«”æ¥è§¸ã¯ï¼Ÿ", q6_a1: "é©åˆ‡", q6_a2: "æ°—ã¾ãšã„", q6_a3: "ä¸å¿«",
            q7: "å±é™ºãªå‹•ä½œã¯ï¼Ÿ", q7_a1: "ãªã‹ã£ãŸ", q7_a2: "å°‘ã—å±ãªã„", q7_a3: "éå¸¸ã«å±éšª",
            q8: "ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æ¡ˆå†…ã¯ï¼Ÿ", q8_a1: "ç©æ¥µçš„", q8_a2: "å—å‹•çš„", q8_a3: "ãªã‹ã£ãŸ",
            q9: "ååˆºã®æä¾›ã¯ï¼Ÿ", q9_a1: "ç©æ¥µçš„", q9_a2: "æ±‚ã‚ãŸã‚‰", q9_a3: "ãªã‹ã£ãŸ",
            q10: "æ¬¡å›ã‚‚æŒ‡åï¼Ÿ", q10_a1: "å¿…ãšæŒ‡å", q10_a2: "ã¾ãŸè©¦ã™", q10_a3: "ã—ãªã„", 
            masseurIdLabel: "ã‚¹ã‚¿ãƒƒãƒ•ç•ªå· *", submitBtn: "é€ä¿¡ã™ã‚‹", ph_masseur: "ç•ªå·", ph_name: "åå‰", ph_phone: "é›»è©±", ph_suggest: "ã”æ„è¦‹...", suc: "âœ… é€ä¿¡å®Œäº†ï¼", err: "âŒ å¤±æ•—", authReady: "æ¥ç¶šå®Œäº†",
            modalTitle: "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼", modalSub: "Success Received", modalText: "æº€è¶³ã„ãŸã ã‘ã¾ã—ãŸã‚‰ã€5ã¤æ˜Ÿã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼", modalGoGoogle: "ä»Šã™ãè©•ä¾¡", modalClose: "æ¬¡å›ã«ã™ã‚‹"
        },
        ko: { 
            title: "ì„œë¹„ìŠ¤ ë§Œì¡±ë„ ì¡°ì‚¬", branchLabel: "ì§€ì ", branchName: "ì¤‘ì²­ì ", dateLabel: "ë‚ ì§œ *", 
            q1: "ë²ˆí˜¸ ì•ˆë‚´ê°€ ìˆì—ˆìŠµë‹ˆê¹Œï¼Ÿ", q1_a1: "ì ê·¹ ì•ˆë‚´", q1_a2: "ë‚˜ì¤‘ì—", q1_a3: "ì—†ìŒ", 
            q2: "ì••ë ¥ ì¡°ì ˆ í™•ì¸ì€ï¼Ÿ", q2_a1: "ì ê·¹ í™•ì¸", q2_a2: "ìˆ˜ë™ì ", q2_a3: "ì—†ìŒ",
            q3: "ì²´ì·¨ê°€ ë¶ˆí¸í–ˆìŠµë‹ˆê¹Œï¼Ÿ", q3_a1: "ì—†ìŒ", q3_a2: "ì•½ê°„", q3_a3: "ì‹¬í•¨",
            q4: "ì‹œê°„ ê´€ë¦¬ëŠ”ï¼Ÿ", q4_a1: "ë§Œì¡±", q4_a2: "ë³´í†µ", q4_a3: "ë¶ˆë§Œ",
            q5: "ë§¤ë„ˆê°€ ë¬´ë¡€í–ˆìŠµë‹ˆê¹Œï¼Ÿ", q5_a1: "ì •ì¤‘í•¨", q5_a2: "ë³´í†µ", q5_a3: "ë¬´ë¡€í•¨",
            q6: "ë¶ˆí¸í•œ ì‹ ì²´ ì ‘ì´‰ì€ï¼Ÿ", q6_a1: "ì „ë¬¸ì ", q6_a2: "ë‹¹í™©í•¨", q6_a3: "ë¶ˆì¾Œí•¨",
            q7: "ìœ„í—˜í•œ ë™ì‘ì€ï¼Ÿ", q7_a1: "ì—†ìŒ", q7_a2: "ìœ„í—˜", q7_a3: "ë§¤ìš° ìœ„í—˜",
            q8: "ì´ë²¤íŠ¸ ì•ˆë‚´ëŠ”ï¼Ÿ", q8_a1: "ì ê·¹ì ", q8_a2: "ìˆ˜å‹•ì ", q8_a3: "ì—†ìŒ",
            q9: "ëª…í•¨ ì œê³µì€ï¼Ÿ", q9_a1: "ì ê·¹ì ", q9_a2: "ìš”ì²­ ì‹œ", q9_a3: "ì—†ìŒ",
            q10: "ë˜ ì§€ëª…í•˜ì‹œê² ìŠµë‹ˆê¹Œï¼Ÿ", q10_a1: "ê¼­ ì§€ëª…", q10_a2: "ë‹¤ì‹œ ì‹œë„", q10_a3: "ì•ˆ í•¨", 
            masseurIdLabel: "ê´€ë¦¬ì‚¬ ë²ˆí˜¸ *", submitBtn: "ì„¤ë¬¸ ì œì¶œ", ph_masseur: "ë²ˆí˜¸", ph_name: "ì„±í•¨", ph_phone: "ì „í™”", ph_suggest: "ì˜ê²¬...", suc: "âœ… ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤ï¼", err: "âŒ ì‹¤íŒ¨", authReady: "ì—°ê²° ì™„ë£Œ",
            modalTitle: "ê°ì‚¬í•©ë‹ˆë‹¤!", modalSub: "Success Received", modalText: "ë§Œì¡±í•˜ì…¨ë‹¤ë©´ ë³„ 5ê°œ ë¦¬ë·°ë¥¼ ë¶€íƒë“œë¦½ë‹ˆë‹¤!", modalGoGoogle: "ì§€ê¸ˆ ë¦¬ë·°í•˜ê¸°", modalClose: "ë‹¤ìŒì— í•˜ê¸°"
        }
    };

    function applyTimeConstraints() {
        const dateInput = document.getElementById('serviceDate'); if(!dateInput) return;
        const now = new Date(); const yesterday = new Date(now.getTime() - (24 * 60 * 60 * 1000));
        const toISO = (d) => d.toISOString().split('T')[0];
        dateInput.max = toISO(now); dateInput.min = toISO(yesterday); dateInput.value = toISO(now);
    }

    // --- è‡ªå‹•å°é½Šæ¸²æŸ“å¼•æ“ ---
    function renderQuestions() {
        const container = document.getElementById('questionsContainer'); if(!container) return;
        container.innerHTML = '';
        for(let i=1; i<=10; i++) {
            container.innerHTML += `
            <div class="bg-white p-6 question-card shadow-sm border border-gray-100">
                <p class="font-bold text-gray-800 mb-4 text-base leading-snug">
                    ${i}. <span data-i18n="q${i}">...</span>
                </p>
                <div class="space-y-3">
                    ${[1,2,3].map(a => `
                        <label class="flex items-center p-4 border rounded-2xl border-gray-100 bg-gray-50/50 active:bg-blue-50 transition cursor-pointer">
                            <input type="radio" name="q${i}" value="" class="w-5 h-5 mr-3" required> 
                            <span data-i18n="q${i}_a${a}">...</span>
                        </label>`).join('')}
                </div>
            </div>`;
        }
    }

    // --- å…¨æ–¹ä½è‡ªå‹•å°é½Šç¿»è­¯å¼•æ“ ---
    window.changeLang = function(lang) {
        document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.getElementById(`btn-${lang}`); if(activeBtn) activeBtn.classList.add('active');
        const trans = translations[lang] || translations['zh'];
        
        // 1. å°é½Šæ‰€æœ‰ data-i18n æ¨™ç±¤ (åŒ…å«å‹•æ…‹é¡Œç›®èˆ‡é¸é …)
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (trans[key]) {
                el.innerHTML = trans[key];
                
                // æ ¸å¿ƒé‚è¼¯ï¼šå¦‚æœæ˜¯ Radio çš„ Label Spanï¼ŒåŒæ­¥æ›´æ–°å…¶ Input çš„ Value
                const radioInput = el.previousElementSibling;
                if (radioInput && radioInput.type === 'radio') {
                    radioInput.value = trans[key]; // ç¢ºä¿å¯«å…¥ Firestore çš„å…§å®¹éš¨èªè¨€è®Šå‹•
                }
            }
        });
        
        // 2. å°é½Šæ‰€æœ‰ data-ph ä½”ä½ç¬¦
        document.querySelectorAll('[data-ph]').forEach(el => {
            const key = el.getAttribute('data-ph');
            if (trans[key]) el.placeholder = trans[key];
        });

        const info = document.getElementById('conn-info'); if(isAuthorized && info) info.innerText = trans.authReady;
    };

    onAuthStateChanged(auth, (user) => {
        if(user) {
            isAuthorized = true;
            const btn = document.getElementById('submitBtn'); if(btn) { btn.disabled = false; btn.classList.remove('opacity-50'); }
            const activeLangBtn = document.querySelector('.lang-btn.active');
            window.changeLang(activeLangBtn ? activeLangBtn.id.split('-')[1] : 'zh');
        }
    });

    window.handleMarketingAction = async (action) => {
        if (!lastDocId) return;
        try {
            const docRef = doc(db, 'apps', 'zhongqing-v1', 'surveys', lastDocId);
            await updateDoc(docRef, { marketingAction: action });
            if (action === 'Reviewed') window.open("https://maps.app.goo.gl/1Rto7b5TRNNF35yf8", "_blank");
            document.getElementById('successModal').classList.replace('modal-show', 'modal-hide');
        } catch (e) { console.error("Update Action Fail"); }
    };

    document.getElementById('surveyForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if(!isAuthorized || !auth.currentUser) return;
        const btn = document.getElementById('submitBtn');
        const lang = document.querySelector('.lang-btn.active').id.split('-')[1];
        const t = translations[lang];
        
        btn.disabled = true; btn.innerText = "...Processing...";
        const ratings = {};
        for(let i=1; i<=10; i++) {
            const c = document.querySelector(`input[name="q${i}"]:checked`);
            ratings[`q${i}`] = c ? c.value : null;
        }
        const surveyData = { branch: t.branchName, masseurId: document.getElementById('masseurId').value, customerName: document.getElementById('custName').value || "Anonymous", customerPhone: document.getElementById('custPhone').value || "N/A", serviceDate: document.getElementById('serviceDate').value, suggestions: document.getElementById('suggestions').value, ratings: ratings, submittedLang: lang, createdAt: serverTimestamp(), marketingAction: 'Pending' };
        try {
            const docRef = await addDoc(collection(db, 'apps', 'zhongqing-v1', 'surveys'), surveyData);
            lastDocId = docRef.id;
            document.getElementById('surveyForm').reset();
            applyTimeConstraints();
            document.getElementById('successModal').classList.replace('modal-hide', 'modal-show');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } catch(err) { showToast(`${t.err} (${err.code})`, "bg-red-600"); } finally { btn.disabled = false; btn.innerText = t.submitBtn; }
    });

    function showToast(msg, color) {
        const t = document.getElementById('toast'); if(!t) return;
        t.innerText = msg;
        t.className = `fixed bottom-10 left-1/2 -translate-x-1/2 ${color} text-white px-8 py-4 rounded-full shadow-2xl transition-all z-50 text-sm font-bold min-w-[280px] opacity-100 text-center`;
        setTimeout(() => t.className = t.className.replace('opacity-100', 'opacity-0'), 5000);
    }
    window.onload = () => { renderQuestions(); applyTimeConstraints(); window.changeLang('zh'); signInAnonymously(auth); };
</script>
</body>
</html>
